<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tyvila TV — Live Matches</title>
<link rel="icon" href="https://www.tyvila.online/cdn/ty.webp" />
<style>
:root{
  --bg1:#071029;
  --card:#0f1724;
  --accent:#6ef3ff;
  --accent2:#9b7bff;
  --muted:#9fb2c8;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),#00101a);color:#e6f0fb;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
.header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;gap:12px}
.brand{display:flex;align-items:center;gap:14px}
.logo{height:56px;border-radius:8px}
.title{font-weight:800;font-size:20px}
.sub{color:var(--muted);font-size:13px}
.container{max-width:1200px;margin:18px auto;padding:12px}
.grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.liveCard{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px}
.liveMeta{display:flex;gap:12px;align-items:center}
.badge{padding:6px 10px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;font-weight:800}
.small{color:var(--muted);font-size:13px}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#021;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.tvWindow{background:#000;border-radius:10px;height:360px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.controls{display:flex;gap:8px;align-items:center;margin-top:12px}
.recordingList{max-height:420px;overflow:auto;margin-top:8px}
.noLive{color:var(--muted);padding:18px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:center}
.player{display:flex;gap:8px;align-items:center}
.avatar{height:36px;width:36px;border-radius:8px;object-fit:cover}
.replayBoard{display:grid;grid-template-columns:repeat(3,86px);gap:8px;justify-content:center;background:transparent;padding:12px;border-radius:10px}
.replayCell{width:86px;height:86px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:36px;border-radius:8px}
.footer{margin-top:18px;color:var(--muted);text-align:center}
@media (max-width:980px){
  .grid{grid-template-columns:1fr; padding:12px}
  .tvWindow{height:300px}
  .replayCell{width:64px;height:64px;font-size:28px}
}
</style>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const SUPABASE_URL = 'https://wwcedhbbdoyrmquokyjj.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3Y2VkaGJiZG95cm1xdW9reWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzYyNjUsImV4cCI6MjA3MTYxMjI2NX0.s29eO4ZQ74R6Jktn5zKZ-AiH6_QYC-_9WFqAS_m1kj4'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let liveGames = []
let recordings = []
let currentReplay = null
let replayIndex = 0
let replayTimer = null

function $(id){return document.getElementById(id)}

async function init(){
  $('sast').textContent = new Date().toLocaleString('en-ZA',{timeZone:'Africa/Johannesburg'})
  setInterval(()=>{$('sast').textContent = new Date().toLocaleString('en-ZA',{timeZone:'Africa/Johannesburg'})},1000)
  await loadLiveGames()
  await loadRecordings()
  subscribeLive()
  $('btnFullscreen').addEventListener('click', ()=>{ const el = $('tvWindow'); if(el.requestFullscreen) el.requestFullscreen(); else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen(); })
  $('btnRefreshLive').addEventListener('click', loadLiveGames)
  $('playReplay').addEventListener('click', playReplay)
  $('pauseReplay').addEventListener('click', pauseReplay)
  $('stepReplay').addEventListener('click', stepReplay)
}

async function loadLiveGames(){
  const { data } = await supabase.from('championships').select('*').order('starts_at',{ascending:true}).limit(1)
  const champ = data?.[0] || null
  let liveQuery = supabase.from('games').select('*,rooms(room_number,name)').eq('live',true)
  const { data: live } = await liveQuery
  liveGames = live || []
  renderLive()
}

function renderLive(){
  const wrap = $('liveList')
  wrap.innerHTML = ''
  if(!liveGames || liveGames.length === 0){ $('noLive').style.display = 'block'; return }
  $('noLive').style.display = 'none'
  for(const g of liveGames){
    const card = document.createElement('div'); card.className='liveCard'
    const players = (g.state?.players || []).map(p=>p.name || p.id).join(' vs ')
    card.innerHTML = `<div class="liveMeta"><div><strong>Room ${g.rooms?.room_number || ''}</strong><div class="small">${g.rooms?.name || ''}</div><div class="small">${players}</div></div></div><div><button class="btn watch" data-room="${g.rooms?.room_number}" data-game="${g.id}">Watch</button></div>`
    wrap.appendChild(card)
  }
  Array.from(wrap.querySelectorAll('.watch')).forEach(b=>b.addEventListener('click', e=>openWatch(e.target.dataset.game)))
}

function openWatch(gameId){
  const g = liveGames.find(x=>x.id === gameId)
  if(!g) return alert('Game not found')
  const players = (g.state?.players || []).map(p=>p.name || p.id).join(' vs ')
  $('tvTitle').textContent = `Room ${g.rooms?.room_number || ''} — ${players}`
  animateBoard(g.state?.cells || [])
}

async function loadRecordings(){
  const { data } = await supabase.from('recordings').select('id,created_at,room, state').order('created_at',{ascending:false}).limit(100)
  recordings = data || []
  renderRecordings()
}

function renderRecordings(){
  const list = $('recordList'); list.innerHTML = ''
  if(!recordings || recordings.length === 0){ list.innerHTML = '<div class="small">No previous matches recorded</div>'; return }
  for(const r of recordings){
    const el = document.createElement('div'); el.className = 'liveCard'
    el.innerHTML = `<div><strong>${r.room ? 'Room ' + (r.room?.room_number || r.room) : 'Recording'}</strong><div class="small">${new Date(r.created_at).toLocaleString('en-ZA',{timeZone:'Africa/Johannesburg'})} SAST</div></div><div><button class="btn viewRec" data-id="${r.id}">View</button></div>`
    list.appendChild(el)
  }
  Array.from(list.querySelectorAll('.viewRec')).forEach(b=>b.addEventListener('click', async e=>{
    const id = e.target.dataset.id
    const { data } = await supabase.from('recordings').select('*').eq('id', id).single().catch(()=>({data:null}))
    if(!data) return alert('Recording not found')
    currentReplay = data.state?.cells || data.state?.cells?.slice() || []
    replayIndex = 0
    $('tvTitle').textContent = `Recording: ${new Date(data.created_at).toLocaleString('en-ZA',{timeZone:'Africa/Johannesburg'})}`
    animateBoard([])
  }))
}

function animateBoard(cells){
  const tv = $('tvWindow')
  const boardWrap = $('tvBoard')
  boardWrap.innerHTML = ''
  for(let i=0;i<9;i++){
    const d = document.createElement('div'); d.className='replayCell'; d.textContent = ''
    boardWrap.appendChild(d)
  }
  if(currentReplay && currentReplay.length > 0){
    replayIndex = 0
    playReplay()
  } else {
    const liveCells = cells || []
    for(let i=0;i<9;i++) boardWrap.children[i].textContent = liveCells[i] || ''
    pauseReplay()
  }
}

function playReplay(){
  if(!currentReplay || currentReplay.length === 0) return
  $('playReplay').disabled = true
  $('pauseReplay').disabled = false
  if(replayTimer) clearInterval(replayTimer)
  replayTimer = setInterval(()=>{
    if(replayIndex >= currentReplay.length){ clearInterval(replayTimer); $('playReplay').disabled = false; return }
    const cell = currentReplay[replayIndex]
    if(Array.isArray(cell)){ // guard
      for(let i=0;i<9;i++) $('tvBoard').children[i].textContent = cell[i] || ''
      replayIndex++
      return
    }
    const boardCells = currentReplay[replayIndex]
    for(let i=0;i<9;i++) $('tvBoard').children[i].textContent = boardCells[i] || ''
    replayIndex++
  }, 600)
}

function pauseReplay(){
  $('playReplay').disabled = false
  $('pauseReplay').disabled = true
  if(replayTimer) clearInterval(replayTimer)
}

function stepReplay(){
  if(!currentReplay || currentReplay.length === 0) return
  if(replayIndex < currentReplay.length){
    const boardCells = currentReplay[replayIndex]
    for(let i=0;i<9;i++) $('tvBoard').children[i].textContent = boardCells[i] || ''
    replayIndex++
  }
}

function subscribeLive(){
  supabase.channel('tv-live').on('postgres_changes',{event:'INSERT',schema:'public',table:'games'},()=>loadLiveGames()).on('postgres_changes',{event:'UPDATE',schema:'public',table:'games'},()=>loadLiveGames()).subscribe()
}

document.addEventListener('DOMContentLoaded', init)
</script>
</head>
<body oncontextmenu="return false;">
  <header class="header">
    <div class="brand">
      <img class="logo" src="https://www.tyvila.online/cdn/ty.webp" alt="tyvila">
      <div>
        <div class="title">Tyvila TV</div>
        <div class="sub">Live matches • Replays • SAST: <span id="sast"></span></div>
      </div>
    </div>
    <div class="small">tyvila.online/xando/</div>
  </header>

  <div class="container">
    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Live Now</strong><div class="small">Live games & championships</div></div>
            <div><button id="btnRefreshLive" class="btn">Refresh</button></div>
          </div>
          <div id="liveList" style="margin-top:12px"></div>
          <div id="noLive" class="noLive" style="display:none;margin-top:12px">no live games yet. maybe start your own<br><br><a class="btn" href="https://tyvila.online/xando/">start a room</a></div>
        </div>

        <div class="card" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Previous Matches</strong><div class="small">Recorded matches you can replay</div></div>
            <div><button id="btnRefreshRec" class="btn" onclick="location.reload()">Refresh</button></div>
          </div>
          <div id="recordList" class="recordingList" style="margin-top:12px"></div>
        </div>
      </div>

      <aside>
        <div class="card tvWindow" id="tvWindow" style="flex-direction:column">
          <div style="width:100%;display:flex;justify-content:space-between;align-items:center;padding:8px 12px">
            <div><strong id="tvTitle">No stream selected</strong><div class="small" id="tvSub">Select a live match or recording</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="btnFullscreen" class="btn">Fullscreen</button>
            </div>
          </div>
          <div id="tvBoard" style="flex:1;display:flex;align-items:center;justify-content:center;padding:8px">
            <div class="replayBoard" id="replayBoard" style="pointer-events:none">
              <div class="replayCell"></div><div class="replayCell"></div><div class="replayCell"></div>
              <div class="replayCell"></div><div class="replayCell"></div><div class="replayCell"></div>
              <div class="replayCell"></div><div class="replayCell"></div><div class="replayCell"></div>
            </div>
          </div>
          <div style="width:100%;padding:10px;border-top:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center">
            <div class="controls">
              <button class="btn" id="playReplay">Play</button>
              <button class="btn" id="pauseReplay" disabled>Pause</button>
              <button class="btn" id="stepReplay">Step</button>
            </div>
            <div class="small">SAST: <span id="sastSmall"></span></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>How TV works</strong>
          <div class="small" style="margin-top:8px">
            Live games are shown by subscribing to the games table. Recordings are snapshots saved at game end. Admins may stream to YouTube/Twitch via admin panel.
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">Tyvila X & O • Watch live games • Recordings stored in Supabase</div>
  </div>

<script>
document.getElementById('sastSmall').textContent = new Date().toLocaleString('en-ZA',{timeZone:'Africa/Johannesburg'})
setInterval(()=>{document.getElementById('sastSmall').textContent = new Date().toLocaleString('en-ZA',{timeZone:'Africa/Johannesburg'})},1000)
</script>
</body>
</html>
